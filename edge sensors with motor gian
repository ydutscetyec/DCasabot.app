// === 4-EDGE SENSOR + MOTOR TEST WITH START/STOP BUTTON ===
// FRONT=10, LEFT=13, RIGHT=12, BACK=11
// BUTTON=2 (Active LOW)
// Uses CytronMotorDriver (PWM_DIR mode)

#include <CytronMotorDriver.h>

// === Sensor Pins ===
#define EDGE_FRONT 10
#define EDGE_LEFT  13
#define EDGE_RIGHT 12
#define EDGE_BACK  11
#define START_BUTTON 2  // Active LOW button

// === Motor Pins ===
CytronMD motorL(PWM_DIR, 5, 4); // PWM, DIR
CytronMD motorR(PWM_DIR, 6, 7); // PWM, DIR

// === Constants ===
const int EDGE_TRIGGER = LOW;   // QTR outputs LOW when over white edge
const int ACTION_TIME  = 300;   // ms duration for each reaction
const int BASE_SPEED   = 255;   // Max motor speed (0–255)

// === State Variables ===
bool running = false;
bool lastButtonState = HIGH;

void setup() {
  Serial.begin(9600);

  // Sensor & button setup
  pinMode(EDGE_FRONT, INPUT_PULLUP);
  pinMode(EDGE_LEFT, INPUT_PULLUP);
  pinMode(EDGE_RIGHT, INPUT_PULLUP);
  pinMode(EDGE_BACK, INPUT_PULLUP);
  pinMode(START_BUTTON, INPUT_PULLUP);

  // Motors idle
  motorL.setSpeed(0);
  motorR.setSpeed(0);

  Serial.println("=== 4-EDGE SENSOR + MOTOR TEST READY ===");
  Serial.println("Press the button to START or STOP...");
}

void loop() {
  bool buttonState = digitalRead(START_BUTTON);

  // === Toggle Test Start/Stop ===
  if (lastButtonState == HIGH && buttonState == LOW) {
    running = !running;
    if (running) Serial.println("\n>>> TEST STARTED <<<");
    else {
      Serial.println("\n>>> TEST STOPPED <<<");
      motorL.setSpeed(0);
      motorR.setSpeed(0);
    }
    delay(250); // debounce
  }
  lastButtonState = buttonState;

  if (!running) return; // skip logic when stopped

  // === Read Sensors ===
  bool frontEdge = (digitalRead(EDGE_FRONT) == EDGE_TRIGGER);
  bool leftEdge  = (digitalRead(EDGE_LEFT) == EDGE_TRIGGER);
  bool rightEdge = (digitalRead(EDGE_RIGHT) == EDGE_TRIGGER);
  bool backEdge  = (digitalRead(EDGE_BACK) == EDGE_TRIGGER);

  // === Print Sensor States ===
  Serial.print("Front: "); Serial.print(frontEdge ? "EDGE" : "SAFE");
  Serial.print(" | Left: "); Serial.print(leftEdge ? "EDGE" : "SAFE");
  Serial.print(" | Right: "); Serial.print(rightEdge ? "EDGE" : "SAFE");
  Serial.print(" | Back: "); Serial.println(backEdge ? "EDGE" : "SAFE");

  // === Decision Logic ===
  if (frontEdge) {
    Serial.println("Front EDGE → Reversing");
    motorL.setSpeed(-BASE_SPEED);
    motorR.setSpeed(-BASE_SPEED);
    delay(ACTION_TIME);
  }
  else if (leftEdge) {
    Serial.println("Left EDGE → Turning RIGHT");
    motorL.setSpeed(BASE_SPEED);
    motorR.setSpeed(-BASE_SPEED);
    delay(ACTION_TIME);
  }
  else if (rightEdge) {
    Serial.println("Right EDGE → Turning LEFT");
    motorL.setSpeed(-BASE_SPEED);
    motorR.setSpeed(BASE_SPEED);
    delay(ACTION_TIME);
  }
  else if (backEdge) {
    Serial.println("Back EDGE → Moving FORWARD");
    motorL.setSpeed(BASE_SPEED);
    motorR.setSpeed(BASE_SPEED);
    delay(ACTION_TIME);
  }
  else {
    // ✅ All sensors SAFE (black)
    Serial.println("All sensors SAFE → STOPPED");
    motorL.setSpeed(0);
    motorR.setSpeed(0);
  }

  delay(100);
}
